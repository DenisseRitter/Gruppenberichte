<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gruppenbericht – FINAL (CLX→CXL Fix + Charts + HTML-Snapshot)</title>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

<style>
  :root{
    --blue:#0b2a4a; --blue2:#123b66; --gold:#d4af37;
    --ink:#1d1d1f; --muted:#4a4a52; --bad:#c62828;
    --bg1:#ffe6f2; --bg2:#fff4e6;
  }
  body{
    margin:0; padding:18px;
    font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--ink);
    background:
      radial-gradient(1200px 600px at 12% 10%, var(--bg1), transparent 60%),
      radial-gradient(1100px 600px at 85% 15%, var(--bg2), transparent 55%),
      linear-gradient(135deg, #fff 0%, #fff6fb 45%, #fff7ef 100%);
    min-height:100vh;
  }
  header{ display:flex; align-items:center; gap:14px; flex-wrap:wrap; margin-bottom:10px; }
  header img{ height:54px; filter: drop-shadow(0 6px 10px rgba(0,0,0,.10)); }
  h1{ margin:0; font-size:22px; color:var(--blue); letter-spacing:.2px; }
  .sub{ margin-top:4px; color:var(--muted); font-size:12px; font-weight:500; letter-spacing:.2px; }

  .bar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0 12px; }

  .btn{
    appearance:none; border:0; cursor:pointer;
    padding:10px 12px; border-radius:12px;
    background:linear-gradient(135deg,var(--blue),var(--blue2));
    color:#fff; font-weight:900;
    box-shadow:0 10px 18px rgba(11,42,74,.25);
  }
  .btn.secondary{
    background:rgba(255,255,255,.82);
    color:var(--blue);
    border:1px solid rgba(11,42,74,.25);
    font-weight:900;
    box-shadow:0 10px 18px rgba(0,0,0,.08);
  }
  .btn.toggle{
    background:rgba(255,255,255,.82);
    color:var(--blue);
    border:1px solid rgba(11,42,74,.22);
    box-shadow:0 10px 18px rgba(0,0,0,.08);
  }
  .btn.toggle.active{
    background:linear-gradient(135deg,var(--blue),var(--blue2));
    color:var(--gold);
    border:1px solid rgba(212,175,55,.55);
  }

  .file, .ctrl{
    display:flex; gap:8px; align-items:center;
    padding:10px 12px; border-radius:12px;
    background:rgba(255,255,255,.82);
    border:1px solid rgba(11,42,74,.18);
    box-shadow:0 10px 18px rgba(0,0,0,.08);
  }
  .file label, .ctrl label{ font-size:13px; color:var(--blue); font-weight:900; white-space:nowrap; }
  .ctrl input, .ctrl select{
    padding:8px 10px; border-radius:10px;
    border:1px solid rgba(11,42,74,.22);
    background:rgba(255,255,255,.98);
    font-size:12px; outline:none; color:var(--ink);
  }
  .ctrl .tiny{ width: 140px; }
  .ctrl .check{ display:flex; align-items:center; gap:6px; font-size:12px; color:var(--blue); font-weight:800; }

  .card{
    background:rgba(255,255,255,.86);
    backdrop-filter: blur(8px);
    border:1px solid rgba(11,42,74,.18);
    border-radius:18px;
    box-shadow:0 14px 30px rgba(0,0,0,.12);
    overflow:hidden;
  }

  .summary{
    display:flex; gap:10px; flex-wrap:wrap;
    padding:14px 16px;
    border-bottom:2px solid rgba(212,175,55,.35);
    align-items:center;
    justify-content:flex-start;
    background:linear-gradient(90deg, rgba(11,42,74,.08), rgba(212,175,55,.10));
  }
  .pill{
    display:flex; gap:10px; align-items:baseline;
    padding:10px 12px;
    border-radius:999px;
    background:rgba(255,255,255,.94);
    border:1px solid rgba(11,42,74,.18);
    font-weight:900;
  }
  .pill b{ color:var(--blue); font-size:13px; }
  .pill span{ font-size:12px; color:var(--ink); }

  .note{ padding:10px 16px 0; color:var(--muted); font-size:12px; }

  table.dataTable{ width:100% !important; border-collapse:separate !important; border-spacing:0; }
  table.dataTable thead th{
    background:rgba(11,42,74,.10);
    border-bottom:2px solid rgba(11,42,74,.35) !important;
    color:var(--blue);
    text-align:center !important;
    font-weight:950;
  }
  table.dataTable tbody td{
    border-bottom:1px solid rgba(43,43,47,.30) !important;
    text-align:center !important;
    vertical-align:middle;
    font-weight:400;
    color:var(--ink);
    white-space:nowrap;
  }
  table.dataTable tbody tr:hover{ background:rgba(255,231,243,.35); }

  thead .filter-row th{
    padding:8px 10px;
    background:rgba(255,255,255,.82);
    border-bottom:1px solid rgba(11,42,74,.20) !important;
  }
  .col-filter{
    width:100%;
    padding:8px 10px;
    border-radius:10px;
    border:1px solid rgba(11,42,74,.22);
    background:rgba(255,255,255,.98);
    outline:none;
    font-size:12px;
    color:var(--ink);
    text-align:center;
    font-weight:600;
  }

  th.bbcol, td.bbcol{ max-width:360px; overflow:hidden; text-overflow:ellipsis; }
  th.accol, td.accol{ max-width:440px; overflow:hidden; text-overflow:ellipsis; }
  th.mktcol, td.mktcol{ min-width:135px; width:135px; }
  th.rmcol, td.rmcol{ min-width:88px; width:88px; }

  td.neg{ color:var(--bad) !important; font-weight:700; }
  tr.ten-row{ background:rgba(212,175,55,.18) !important; }
  tr.ten-row:hover{ background:rgba(212,175,55,.28) !important; }

  .dt-buttons .dt-button{
    background:var(--blue) !important;
    color:var(--gold) !important;
    border:1px solid rgba(212,175,55,.55) !important;
    border-radius:12px !important;
    font-weight:950 !important;
    box-shadow:0 10px 18px rgba(11,42,74,.18);
  }

  div.dt-button-collection{
    background:var(--blue) !important;
    border:1px solid rgba(212,175,55,.65) !important;
    box-shadow:0 14px 30px rgba(0,0,0,.28) !important;
    padding:8px !important;
    border-radius:12px !important;
    z-index:999999 !important;
  }
  div.dt-button-collection a.dt-button{
    display:block !important;
    width:260px !important;
    text-align:left !important;
    padding:10px 12px !important;
    margin:4px 0 !important;
    border-radius:10px !important;
    background:rgba(255,255,255,.06) !important;
    color:var(--gold) !important;
    border:1px solid rgba(212,175,55,.22) !important;
    font-weight:900 !important;
  }
  div.dt-button-collection a.dt-button:hover{ background:rgba(212,175,55,.14) !important; }
  div.dt-button-collection a.dt-button.active{
    background:rgba(212,175,55,.18) !important;
    border:1px solid rgba(212,175,55,.70) !important;
  }
  div.dt-button-collection a.dt-button.active::before{ content:"✓ "; }
  div.dt-button-collection a.dt-button:not(.active)::before{ content:"◻ "; color:rgba(212,175,55,.75); }

  .cell-select{
    width:100%;
    padding:6px 8px;
    border-radius:10px;
    border:1px solid rgba(11,42,74,.25);
    background:rgba(255,255,255,.98);
    font-weight:600;
    color:var(--ink);
  }
  .cell-check{
    transform:scale(1.2);
    accent-color:var(--blue);
    cursor:pointer;
  }

  @media print{
    header, .bar, .dt-buttons, .dataTables_length, .dataTables_filter, .dataTables_info, .dataTables_paginate { display:none !important; }
    .card{ box-shadow:none; border:0; }
    table{ font-size:10px !important; }
    @page { size:A4 landscape; margin:10mm; }
  }
</style>
</head>

<body>
<header>
  <img src="Logo_ibis_RGB.png" alt="Logo_ibis_RGB">
  <div>
    <h1>Gruppenbericht</h1>
    <div class="sub">Fix: Opera liefert CLX (nicht CXL) → CLX wird als CXL behandelt • Charts: gefilterte Zeilen + Market-Split • Snapshot teilen</div>
  </div>
</header>

<div class="bar">
  <button class="btn secondary" id="resetBtn" type="button">Filter zurücksetzen</button>
  <button class="btn secondary" id="clearBtn" type="button">Tabelle leeren</button>
  <button class="btn" id="pdfBtn" type="button">PDF herunterladen</button>
  <button class="btn" id="saveHtmlBtn" type="button">HTML mit Daten speichern</button>

  <button class="btn secondary" id="sortRevCurBtn" type="button">Sort: Revenue Cur ↓</button>
  <button class="btn secondary" id="sortRevPickBtn" type="button">Sort: Revenue Pick ↓</button>
  <button class="btn secondary" id="sortResetBtn" type="button">Sort Reset</button>

  <button class="btn toggle" id="washQuickBtn" type="button">Nur Wash = true</button>
  <button class="btn toggle" id="mktAllBtn" type="button">Market: Alle</button>
  <button class="btn toggle" id="mktCorpBtn" type="button">Market: Corporate</button>
  <button class="btn toggle" id="mktLeisBtn" type="button">Market: Leisure</button>

  <div class="file">
    <label for="importFiles"><b>Import</b> (mehrere möglich):</label>
    <input id="importFiles" type="file" accept=".txt,.csv" multiple>
  </div>

  <div class="ctrl">
    <label>Status:</label>
    <select id="statusSelect">
      <option value="">Alle</option>
      <option value="ACT">ACT</option>
      <option value="DEF">DEF</option>
      <option value="TEN">TEN</option>
      <option value="CXL">CXL</option>
    </select>
  </div>

  <div class="ctrl">
    <label>Anreise:</label>
    <input class="tiny" id="arrFrom" type="date">
    <input class="tiny" id="arrTo" type="date">
  </div>

  <div class="ctrl">
    <label>Abreise:</label>
    <input class="tiny" id="depFrom" type="date">
    <input class="tiny" id="depTo" type="date">
  </div>

  <div class="ctrl">
    <label>Monat (Anreise):</label>
    <select id="monthSelect" title="Filter nach Anreise-Monat">
      <option value="">Alle</option>
      <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mär</option>
      <option value="4">Apr</option><option value="5">Mai</option><option value="6">Jun</option>
      <option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option>
      <option value="10">Okt</option><option value="11">Nov</option><option value="12">Dez</option>
    </select>
  </div>

  <button class="btn secondary" id="sortMonthBtn" type="button" title="Sortierung nach Anreise-Monat (und Datum)">Sort: Monat (Anreise) ↑</button>

  <div class="ctrl">
    <div class="check">
      <input id="negOnly" type="checkbox">
      <label for="negOnly">Nur negative Zeilen (Rev Cur/Pick &lt; 0)</label>
    </div>
  </div>
</div>

<div class="card">
  <div class="summary">
    <div class="pill"><b>Zeilen:</b> <span id="f_rows">0</span></div>
    <div class="pill"><b>Rm Cur:</b> <span id="f_rmcur">0</span></div>
    <div class="pill"><b>Rm Pick:</b> <span id="f_rmpick">0</span></div>
    <div class="pill"><b>Revenue Cur:</b> <span id="f_rev">0.00 CHF</span></div>
    <div class="pill"><b>Revenue Pick:</b> <span id="f_prev">0.00 CHF</span></div>
    <div class="pill"><b>CXL total:</b> <span id="dbg_cxl_total">0</span></div>
    <div class="pill"><b>CXL gefiltert:</b> <span id="dbg_cxl_filtered">0</span></div>
  </div>

  <div class="note">
    Hinweis: Opera liefert häufig <b>CLX</b>. Dieses Tool mappt <b>CLX → CXL</b>, damit Filter/Sort/Charts funktionieren.
  </div>

  <div style="padding:10px 12px 16px;">
    <table id="reportTable" class="display" style="width:100%">
      <thead>
        <tr class="filter-row">
          <th class="bbcol"><input class="col-filter" placeholder="Business Block"></th>
          <th class="accol"><input class="col-filter" placeholder="Account Name"></th>
          <th><input class="col-filter" placeholder="Wash (true/false)"></th>
          <th class="mktcol"><input class="col-filter" placeholder="Market"></th>
          <th><input class="col-filter" placeholder="Anreise"></th>
          <th><input class="col-filter" placeholder="Abreise"></th>
          <th class="rmcol"><input class="col-filter" placeholder="Rm Cur"></th>
          <th><input class="col-filter" placeholder="Revenue Cur"></th>
          <th><input class="col-filter" placeholder="Avg Rate Cur"></th>
          <th class="rmcol"><input class="col-filter" placeholder="Rm Pick"></th>
          <th><input class="col-filter" placeholder="Revenue Pick"></th>
          <th><input class="col-filter" placeholder="Avg Rate Pick"></th>
          <th><input class="col-filter" placeholder="BB Id"></th>
          <th><input class="col-filter" placeholder="Status"></th>
          <th><input class="col-filter" placeholder="Quelle"></th>
          <th><input class="col-filter" placeholder="StatusCode (hidden)"></th>
        </tr>

        <tr>
          <th class="bbcol">Business Block Name</th>
          <th class="accol">Account Name</th>
          <th>Wash-Potenzial</th>
          <th class="mktcol">Market</th>
          <th>Anreise</th>
          <th>Abreise</th>
          <th class="rmcol">Rm Cur</th>
          <th>Revenue Cur</th>
          <th>Avg Rate Cur</th>
          <th class="rmcol">Rm Pick</th>
          <th>Revenue Pick</th>
          <th>Avg Rate Pick</th>
          <th>BB Id</th>
          <th>Status</th>
          <th>Quelle</th>
          <th>StatusCode</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="card" style="margin-top:14px;">
  <div class="summary" style="justify-content:space-between;">
    <div class="pill"><b>Charts:</b> <span>Gefilterte Zeilen • Market-Split</span></div>
    <button class="btn secondary" id="chartsResetBtn" type="button">Charts Reset</button>
  </div>

  <div style="padding:14px 16px;">
    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap:14px;">
      <div class="card" style="padding:12px;">
        <div style="font-weight:900; color:var(--blue); margin-bottom:8px;">Revenue Cur vs Pick (Market-Split)</div>
        <canvas id="ch_rev_split" height="170"></canvas>
      </div>
      <div class="card" style="padding:12px;">
        <div style="font-weight:900; color:var(--blue); margin-bottom:8px;">Revenue Cur nach Status (Market-Split)</div>
        <canvas id="ch_status_stack" height="170"></canvas>
      </div>
      <div class="card" style="padding:12px;">
        <div style="font-weight:900; color:var(--blue); margin-bottom:8px;">Trend nach Anreise (KW) – Revenue Cur (Market-Split)</div>
        <canvas id="ch_trend_kw" height="170"></canvas>
      </div>
      <div class="card" style="padding:12px;">
        <div style="font-weight:900; color:var(--blue); margin-bottom:8px;">Top 10 Business Blocks – Revenue Cur (Market-Split)</div>
        <canvas id="ch_top10_bb" height="220"></canvas>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
/* =================== Schweizer Format + CHF + Negative Klammern =================== */
function toNumber(x){
  if (x === null || x === undefined) return 0;
  const s = String(x).trim().replace(/\\s/g,'').replace(/CHF/gi,'').replace(/,/g,'');
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}
function fmt2(n){ return Number(n).toLocaleString("de-CH",{minimumFractionDigits:2,maximumFractionDigits:2}); }
function fmtMoney(n){
  const val = Number(n);
  if (val < 0) return "(" + fmt2(Math.abs(val)) + ")";
  return fmt2(val);
}
function renderInt(data, type){
  const n = Math.round(toNumber(data));
  if (type === 'display') return String(n);
  return n;
}
function renderCHF(data, type){
  const n = toNumber(data);
  if (type === 'display') return fmtMoney(n) + " CHF";
  return n;
}
function renderRate(data, type){
  const n = toNumber(data);
  if (type === 'display') return fmtMoney(n);
  return n;
}

/* =================== Editable columns =================== */
const MARKET_OPTIONS = ["", "Corporate", "Leisure"];

/* =================== Auto-Market: Leisure bei bestimmten Account Names =================== */
const AUTO_LEISURE_ACCOUNTS = [
  "BEY TOURS","EMETRAVEL","EUROPE INCOMING HOLDINGS LTD.","EURORUTAS TUOR OPERATOR S.L.",
  "MEGA TRAVEL OPERADORA S.A DE C.V","MASEUROPA","GLOBETROTTERS TRAVEL AND TOURS",
  "GOEUGO INTERNATIONAL LTD.","VIYA TRAVEL LTD","PANAVISION TOURS  (CIRCUITOS A FONDO S",
  "EUROPA MUNDO VACACIONES, S.L.U.","G2 TRAVEL LTD.","KUONI GLOBAL TRAVEL SERVICES (SCHWEIZ)",
  "EUROPE INCOMING LONDON","VOSAIO TRAVEL LIMITED","MAPA TOURS"
];
function normAccount(s){
  return String(s ?? "")
    .toUpperCase()
    .replace(/[’']/g, "'")
    .replace(/[“”"]/g, '"')
    .replace(/\\u00A0/g, ' ')
    .replace(/\\s+/g, " ")
    .trim();
}
function shouldAutoLeisure(accountName){
  const n = normAccount(accountName);
  if (!n) return false;
  return AUTO_LEISURE_ACCOUNTS.some(a => {
    const aa = normAccount(a);
    return n.includes(aa) || n.startsWith(aa);
  });
}
function applyAutoLeisureAllRows(){
  if (!dt) return;
  dt.rows().every(function(){
    const r = this.data();
    if (!r) return;
    const acc = r[1];
    if (shouldAutoLeisure(acc)) {
      r[3] = "Leisure";
      this.data(r);
    }
  });
}

function washToBool(val){
  if (val === true) return true;
  const s = String(val ?? "").trim().toLowerCase();
  return (s === "true" || s === "1" || s === "yes" || s === "ja" || s === "y" || s === "✓");
}
function washDisplay(val){ return washToBool(val) ? "true" : "false"; }
function marketNormalize(val){
  const s = String(val ?? "").trim();
  if (!s) return "";
  const found = MARKET_OPTIONS.find(o => o.toLowerCase() === s.toLowerCase());
  return found ?? s;
}
function renderWash(val, type){
  const b = washToBool(val);
  if (type === 'display'){
    return `<input class="cell-check wash-check" type="checkbox" ${b ? "checked":""}>`;
  }
  return b ? "true" : "false";
}
function renderMarket(val, type){
  const v = marketNormalize(val);
  if (type === 'display'){
    const opts = MARKET_OPTIONS.map(o=>{
      const sel = (o && o.toLowerCase() === v.toLowerCase()) ? "selected" : (!o && !v ? "selected":"");
      return `<option value="${o}" ${sel}>${o || "—"}</option>`;
    }).join("");
    return `<select class="cell-select market-select">${opts}</select>`;
  }
  return v || "";
}

/* =================== Robust Delimited Parser =================== */
function parseDelimited(text, delimiter){
  const rows=[]; let row=[]; let cur=''; let inQuotes=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i], next=text[i+1];
    if(ch === '"'){
      if(inQuotes && next === '"'){ cur+='"'; i++; }
      else inQuotes = !inQuotes;
      continue;
    }
    if(!inQuotes && (ch === '\n' || ch === '\r')){
      if(ch === '\r' && next === '\n') i++;
      row.push(cur); rows.push(row); row=[]; cur=''; continue;
    }
    if(!inQuotes && ch === delimiter){
      row.push(cur); cur=''; continue;
    }
    cur += ch;
  }
  row.push(cur); rows.push(row);
  return rows.map(r=>r.map(c=>(c??'').trim())).filter(r=>r.some(c=>c!=='')); 
}
function detectDelimiter(line){
  if(line.includes('\t')) return '\t'; // ✅ TAB
  const comma=(line.match(/,/g)||[]).length;
  const semi=(line.match(/;/g)||[]).length;
  return semi>comma?';':',';
}

/* ✅ Header-Normalisierung: BOM/Leerzeichen/Underscore/Quotes egal */
function normHeaderKey(name){
  return String(name ?? '')
    .replace(/^\uFEFF/, '')          // BOM
    .replace(/["']/g,'')
    .trim()
    .toUpperCase()
    .replace(/[^A-Z0-9]/g,'');       // entfernt _ / Leerzeichen / Sonderzeichen
}
function buildHeaderMap(headerRow){
  const map={};
  headerRow.forEach((name,idx)=>{
    const k = normHeaderKey(name);
    if(k) map[k]=idx;
  });
  return map;
}
function getCell(cols,map,name){
  const idx = map[normHeaderKey(name)];
  if(idx===undefined) return '';
  return cols[idx] ?? '';
}

/* ✅ Finde Header-Zeile (Opera hat manchmal Report-Zeilen vor dem Header) */
function findHeaderRowIndex(rows){
  const wantedA = normHeaderKey('ARRIVALDATE');
  const wantedD = normHeaderKey('DEPARTUREDATE');
  const maxScan = Math.min(rows.length, 40);
  for(let i=0;i<maxScan;i++){
    const r = rows[i] || [];
    const keys = r.map(normHeaderKey);
    if(keys.includes(wantedA) && keys.includes(wantedD)) return i;
  }
  return -1;
}

function isFooterOrLabel(firstCell){
  const v=(firstCell||'').trim();
  return v.startsWith('CF_NAME_FILTER') || v==='Filter' || v.startsWith('CF_');
}
function isGrandTotal(cols,map){
  const groupBy=getCell(cols,map,'GROUP_BY');
  const col1=getCell(cols,map,'COL1');
  const bookId=(getCell(cols,map,'BOOK_ID')||'').trim();
  return (groupBy==='ALL' && col1==='ALL' && bookId==='');
}
function isCurrencyOrVariance(cols,map){
  const col1=(getCell(cols,map,'COL1')||'').trim().toLowerCase();
  const col2=(getCell(cols,map,'COL2')||'').trim().toLowerCase();
  const col3=(getCell(cols,map,'COL3')||'').trim().toLowerCase();
  const hay=`${col1} ${col2} ${col3}`;
  return hay.includes('currency') || hay.includes('variance') || hay==='chf' || hay.includes(' chf');
}


/* =================== Date helpers =================== */
function parseOperaDate(d){
  if(!d) return null;
  const s = String(d).trim();
  if(!s) return null;

  // allow "dd.mm.yy", "dd.mm.yyyy", also with "/" as separator
  let m = s.match(/^(\d{1,2})[\.\/]?(\d{1,2})[\.\/]?(\d{2}|\d{4})$/);
  if(m){
    const day = Number(m[1]);
    const mon = Number(m[2]);
    let year = Number(m[3]);
    if(year < 100) year = 2000 + year;
    return new Date(Date.UTC(year, mon-1, day));
  }

  // allow ISO "yyyy-mm-dd" or with time "yyyy-mm-ddTHH:MM..."
  const iso = s.split(/[ T]/)[0];
  m = iso.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(m){
    const year = Number(m[1]), mon = Number(m[2]), day = Number(m[3]);
    return new Date(Date.UTC(year, mon-1, day));
  }

  return null;
}
function parseISODate(s){
  if(!s) return null;
  const m=String(s).trim().match(/^(\\d{4})-(\\d{2})-(\\d{2})$/);
  if(!m) return null;
  return new Date(Date.UTC(Number(m[1]),Number(m[2])-1,Number(m[3])));
}
function operaDateKey(d){
  const dt = parseOperaDate(d);
  if(!dt) return 0;
  const y = dt.getUTCFullYear();
  const m = dt.getUTCMonth()+1;
  const day = dt.getUTCDate();
  return (y*10000) + (m*100) + day; // YYYYMMDD
}
function operaArrMonth(d){
  const dt = parseOperaDate(d);
  return dt ? (dt.getUTCMonth()+1) : null; // 1..12
}
function renderOperaDateSort(data, type){
  if(type === 'sort' || type === 'type'){
    return operaDateKey(data);
  }
  return data;
}


/* =================== Status Fix (CLX → CXL) =================== */
function normStatusRaw(s){
  return String(s ?? "").toUpperCase().replace(/\\u00A0/g,' ').trim();
}
function statusCodeFromAnyText(s){
  const raw = normStatusRaw(s);
  const letters = raw.replace(/[^A-Z]/g,'');
  if(!letters) return "OTHER";

  if (letters === "CLX") return "CXL";
  if (letters.includes("CANCEL") || letters.includes("CANCELL")) return "CXL";
  if (letters.includes("CXL")) return "CXL";

  if (letters.includes("ACT")) return "ACT";
  if (letters.includes("TEN")) return "TEN";
  if (letters.includes("DEF")) return "DEF";
  return letters;
}
function statusBucketFromCode(code){
  const c = String(code || "").trim().toUpperCase();
  if (c === "ACT") return "ACT";
  if (c === "TEN" || c === "DEF") return "OTB";
  if (c === "CXL") return "CXL";
  return "OTHER";
}

/* Quickfilter state */
let washQuickOn = false;
let marketQuick = "";
let monthQuick = ""; // Anreise-Monat (1..12)

/* DataTables global search hook */
$.fn.dataTable.ext.search.push(function(settings, data){
  if(settings.nTable.id !== 'reportTable') return true;

  if (washQuickOn){
    if (String(data[2]).toLowerCase() !== 'true') return false;
  }
  if (marketQuick){
    if (String(data[3]).toLowerCase() !== marketQuick.toLowerCase()) return false;
  }

  if (monthQuick){
    const arrM = parseOperaDate(data[4]);
    const depM = parseOperaDate(data[5]) || arrM;
    if(!arrM) return false;
    const monthIdx = Number(monthQuick);
    const a = arrM.getTime();
    const d = depM ? depM.getTime() : a;
    const yStart = arrM.getUTCFullYear();
    const yEnd = (depM || arrM).getUTCFullYear();
    let ok = false;
    for(let y=yStart; y<=yEnd; y++){
      const ms = Date.UTC(y, monthIdx-1, 1);
      const me = Date.UTC(y, monthIdx, 1); // next month start
      if(a < me && d >= ms){ ok = true; break; } // overlap
    }
    if(!ok) return false;
  }

  const arr = parseOperaDate(data[4]);
  const dep = parseOperaDate(data[5]);

  const arrFrom = parseISODate(document.getElementById('arrFrom').value);
  const arrTo   = parseISODate(document.getElementById('arrTo').value);
  const depFrom = parseISODate(document.getElementById('depFrom').value);
  const depTo   = parseISODate(document.getElementById('depTo').value);

  function inRange(d, from, to){
    if(!d) return true;
    if(from && d < from) return false;
    if(to){
      const toEnd = new Date(to.getTime()+24*60*60*1000-1);
      if(d > toEnd) return false;
    }
    return true;
  }
  if(!inRange(arr, arrFrom, arrTo)) return false;
  if(!inRange(dep, depFrom, depTo)) return false;

  const negOnly=document.getElementById('negOnly').checked;
  if(negOnly){
    if(!(toNumber(data[7])<0 || toNumber(data[10])<0)) return false;
  }
  return true;
});

/* =================== Storage =================== */
let dt;
const STORAGE_KEY="gruppenbericht_data_clx_cxl_fix_v1";
const COL_STATUS = 13;
const COL_STATUSCODE = 15;

function ensureStatusCode(row){
  row[COL_STATUSCODE] = statusCodeFromAnyText(row[COL_STATUS]);
  return row;
}

function saveTableToLocal(){
  try{
    const rows=dt.rows().data().toArray().map(r=>[...r]);
    rows.forEach(r=>{
      r[2]=washToBool(r[2]);
      r[3]=shouldAutoLeisure(r[1]) ? "Leisure" : marketNormalize(r[3]);
      ensureStatusCode(r);
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
  }catch(e){ console.warn(e); }
}
function loadTableFromLocal(){
  try{
    const saved=localStorage.getItem(STORAGE_KEY);
    if(!saved) return;
    const rows=JSON.parse(saved);
    if(!Array.isArray(rows) || !rows.length) return;
    if(dt.rows().count()>0) return;
    rows.forEach(r=>{
      const rr=[...r];
      rr[2]=washToBool(rr[2]);
      rr[3]=shouldAutoLeisure(rr[1]) ? "Leisure" : marketNormalize(rr[3]);
      rr[COL_STATUSCODE]=statusCodeFromAnyText(rr[COL_STATUS]);
      dt.row.add(rr);
    });
    dt.draw();
  }catch(e){ console.warn(e); }
}

/* =================== Totals + Debug =================== */
function computeTotals(rows){
  let curRev=0, pickRev=0, curRm=0, pickRm=0;
  rows.forEach(r=>{
    curRm  += toNumber(r[6]);
    pickRm += toNumber(r[9]);
    curRev += toNumber(r[7]);
    pickRev += toNumber(r[10]);
  });
  return {rows:rows.length, curRm, pickRm, curRev, pickRev};
}
function countCxl(rows){
  let c=0;
  rows.forEach(r=>{ if(String(r[COL_STATUSCODE]||"").toUpperCase()==="CXL") c++; });
  return c;
}
function updateTotals(){
  const allRows = dt.rows().data().toArray();
  const rows=dt.rows({search:'applied'}).data().toArray();
  const t=computeTotals(rows);
  document.getElementById('f_rows').textContent=t.rows;
  document.getElementById('f_rmcur').textContent=String(Math.round(t.curRm));
  document.getElementById('f_rmpick').textContent=String(Math.round(t.pickRm));
  document.getElementById('f_rev').textContent=fmtMoney(t.curRev)+" CHF";
  document.getElementById('f_prev').textContent=fmtMoney(t.pickRev)+" CHF";
  document.getElementById('dbg_cxl_total').textContent = countCxl(allRows);
  document.getElementById('dbg_cxl_filtered').textContent = countCxl(rows);
}

/* =================== Charts =================== */
let chRevSplit, chStatusStack, chTrendKw, chTop10BB;

function kwKeyFromOperaDate(operaDDMMYY){
  const d = parseOperaDate(operaDDMMYY);
  if(!d) return null;

  const date = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
  const dayNum = (date.getUTCDay() + 6) % 7;
  date.setUTCDate(date.getUTCDate() - dayNum + 3);
  const firstThursday = new Date(Date.UTC(date.getUTCFullYear(), 0, 4));
  const firstDayNum = (firstThursday.getUTCDay() + 6) % 7;
  firstThursday.setUTCDate(firstThursday.getUTCDate() - firstDayNum + 3);
  const week = 1 + Math.round((date - firstThursday) / (7*24*60*60*1000));
  const year = date.getUTCFullYear();
  return `${year}-KW${String(week).padStart(2,'0')}`;
}
function rowMarket(r){
  const m = String(r[3] ?? "").trim().toLowerCase();
  if(m === "corporate") return "Corporate";
  if(m === "leisure") return "Leisure";
  return "—";
}
function getAppliedRows(){ return dt.rows({search:'applied'}).data().toArray(); }

function buildChartData(){
  const rows = getAppliedRows();

  const rev = { Corporate:{cur:0,pick:0}, Leisure:{cur:0,pick:0}, "—":{cur:0,pick:0} };
  const statuses = ["ACT","OTB","CXL","OTHER"];
  const statusAgg = {
    Corporate:Object.fromEntries(statuses.map(s=>[s,0])),
    Leisure:Object.fromEntries(statuses.map(s=>[s,0])),
    "—":Object.fromEntries(statuses.map(s=>[s,0]))
  };
  const trend = {};
  const bbAgg = {};

  rows.forEach(r=>{
    const m = rowMarket(r);
    const cur = toNumber(r[7]);
    const pick = toNumber(r[10]);
    rev[m].cur += cur; rev[m].pick += pick;

    const bucket = statusBucketFromCode(r[COL_STATUSCODE]);
    statusAgg[m][bucket] += cur;

    const kw = kwKeyFromOperaDate(r[4]);
    if(kw){
      trend[kw] ||= {Corporate:0, Leisure:0, "—":0};
      trend[kw][m] += cur;
    }

    const bb = String(r[0] ?? "").trim() || "—";
    bbAgg[bb] ||= {Corporate:0, Leisure:0, "—":0, total:0};
    bbAgg[bb][m] += cur;
    bbAgg[bb].total += cur;
  });

  const markets = ["Corporate","Leisure","—"];
  const kwLabels = Object.keys(trend).sort((a,b)=> a.localeCompare(b,'de'));
  const bbList = Object.entries(bbAgg)
    .map(([name,obj])=>({name,...obj}))
    .sort((a,b)=> Math.abs(b.total)-Math.abs(a.total))
    .slice(0,10);

  return {markets, rev, statuses, statusAgg, kwLabels, trend, bbList};
}

function upsertCharts(){
  const d = buildChartData();

  const labels1 = d.markets;
  const curVals = labels1.map(m=>d.rev[m].cur);
  const pickVals= labels1.map(m=>d.rev[m].pick);

  const ctx1 = document.getElementById('ch_rev_split');
  if(chRevSplit) chRevSplit.destroy();
  chRevSplit = new Chart(ctx1, {
    type:'bar',
    data:{ labels:labels1, datasets:[{label:'Revenue Cur',data:curVals},{label:'Revenue Pick',data:pickVals}] },
    options:{ responsive:true, plugins:{ legend:{position:'top'} } }
  });

  const labels2 = d.statuses;
  const corp = labels2.map(s=>d.statusAgg["Corporate"][s]);
  const leis = labels2.map(s=>d.statusAgg["Leisure"][s]);
  const unk  = labels2.map(s=>d.statusAgg["—"][s]);

  const ctx2 = document.getElementById('ch_status_stack');
  if(chStatusStack) chStatusStack.destroy();
  chStatusStack = new Chart(ctx2, {
    type:'bar',
    data:{ labels:labels2, datasets:[
      {label:'Corporate',data:corp,stack:'rev'},
      {label:'Leisure',data:leis,stack:'rev'},
      {label:'—',data:unk,stack:'rev'}
    ]},
    options:{ responsive:true, plugins:{legend:{position:'top'}}, scales:{ x:{stacked:true}, y:{stacked:true} } }
  });

  const labels3 = d.kwLabels;
  const corpT = labels3.map(k=>d.trend[k]?.Corporate ?? 0);
  const leisT = labels3.map(k=>d.trend[k]?.Leisure ?? 0);
  const unkT  = labels3.map(k=>d.trend[k]?.["—"] ?? 0);

  const ctx3 = document.getElementById('ch_trend_kw');
  if(chTrendKw) chTrendKw.destroy();
  chTrendKw = new Chart(ctx3, {
    type:'line',
    data:{ labels:labels3, datasets:[
      {label:'Corporate',data:corpT,tension:0.25,pointRadius:2},
      {label:'Leisure',data:leisT,tension:0.25,pointRadius:2},
      {label:'—',data:unkT,tension:0.25,pointRadius:2}
    ]},
    options:{ responsive:true, plugins:{legend:{position:'top'}} }
  });

  const ctx4 = document.getElementById('ch_top10_bb');
  const bbLabels = d.bbList.map(x=> x.name.length>42 ? (x.name.slice(0,42)+"…") : x.name);
  const corpBB = d.bbList.map(x=> x.Corporate ?? 0);
  const leisBB = d.bbList.map(x=> x.Leisure ?? 0);
  const unkBB  = d.bbList.map(x=> x["—"] ?? 0);

  if(chTop10BB) chTop10BB.destroy();
  chTop10BB = new Chart(ctx4, {
    type:'bar',
    data:{ labels:bbLabels, datasets:[
      {label:'Corporate',data:corpBB,stack:'bb'},
      {label:'Leisure',data:leisBB,stack:'bb'},
      {label:'—',data:unkBB,stack:'bb'}
    ]},
    options:{ responsive:true, indexAxis:'y', plugins:{legend:{position:'top'}}, scales:{ x:{stacked:true}, y:{stacked:true} } }
  });
}

/* =================== Excel (mit Charts) =================== */
function stripHtml(s){ return String(s ?? "").replace(/<[^>]*>/g,'').trim(); }
function buildAppliedTableForExport(){
  const visibleCols=[];
  dt.columns().every(function(i){ if(this.visible() && i !== COL_STATUSCODE) visibleCols.push(i); });

  const colNames={
    0:'Business Block',1:'Account',2:'Wash-Potenzial',3:'Market',4:'Anreise',5:'Abreise',
    6:'Rm Cur',7:'Revenue Cur',8:'Avg Cur',9:'Rm Pick',10:'Revenue Pick',11:'Avg Pick',
    12:'BB Id',13:'Status',14:'Quelle'
  };

  const rows=dt.rows({search:'applied'}).data().toArray();
  const head = visibleCols.map(i=> colNames[i] || `Col ${i}`);
  const body = rows.map(r=> visibleCols.map(i=>{
    if(i===2) return washDisplay(r[2]);
    if(i===3) return marketNormalize(r[3]);
    if(i===7 || i===10) return fmtMoney(toNumber(r[i]))+" CHF";
    if(i===8 || i===11) return fmtMoney(toNumber(r[i]));
    if(i===6 || i===9) return String(Math.round(toNumber(r[i])));
    return stripHtml(r[i]);
  }));
  return { head, body };
}
function getChartDataUrls(){
  const ids = ["ch_rev_split","ch_status_stack","ch_trend_kw","ch_top10_bb"];
  const out = {};
  ids.forEach(id=>{
    const c=document.getElementById(id);
    out[id]=(c && c.toDataURL)? c.toDataURL("image/png",1.0): null;
  });
  return out;
}
function downloadExcelWithCharts(){
  const charts = getChartDataUrls();
  const t = buildAppliedTableForExport();
  const totals = computeTotals(dt.rows({search:'applied'}).data().toArray());
  const stamp = new Date().toISOString().slice(0,10);

  const css = ""
    + "body{font-family:Calibri,Arial,sans-serif;font-size:11pt;}"
    + "h1{font-size:16pt;margin:0 0 6px 0;}"
    + ".meta{margin:0 0 10px 0;color:#444;}"
    + "table{border-collapse:collapse;width:100%;}"
    + "th,td{border:1px solid #bbb;padding:4px 6px;white-space:nowrap;}"
    + "th{background:#dde7f3;font-weight:bold;}"
    + ".grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0 14px 0;}"
    + ".box{border:1px solid #bbb;padding:8px;}"
    + ".cap{font-weight:bold;margin:0 0 6px 0;}"
    + "img{max-width:100%;height:auto;}";

  const chartBlock = ""
    + "<div class=\"grid\">"
    + "<div class=\"box\"><div class=\"cap\">Revenue Cur vs Pick</div>" + (charts.ch_rev_split ? ("<img src=\"" + charts.ch_rev_split + "\">") : "<i>Chart fehlt</i>") + "</div>"
    + "<div class=\"box\"><div class=\"cap\">Revenue nach Status</div>" + (charts.ch_status_stack ? ("<img src=\"" + charts.ch_status_stack + "\">") : "<i>Chart fehlt</i>") + "</div>"
    + "<div class=\"box\"><div class=\"cap\">Trend KW</div>" + (charts.ch_trend_kw ? ("<img src=\"" + charts.ch_trend_kw + "\">") : "<i>Chart fehlt</i>") + "</div>"
    + "<div class=\"box\"><div class=\"cap\">Top 10 Business Blocks</div>" + (charts.ch_top10_bb ? ("<img src=\"" + charts.ch_top10_bb + "\">") : "<i>Chart fehlt</i>") + "</div>"
    + "</div>";

  const tableHtml = ""
    + "<table><thead><tr>" + t.head.map(h=>"<th>"+h+"</th>").join("") + "</tr></thead><tbody>"
    + t.body.map(row=>"<tr>"+row.map(c=>"<td>"+String(c).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")+"</td>").join("")+"</tr>").join("")
    + "</tbody></table>";

  const html = ""
    + "<html><head><meta charset=\"utf-8\"><style>" + css + "</style></head><body>"
    + "<h1>Gruppenbericht</h1>"
    + "<div class=\"meta\">"
    + "Stand: " + stamp
    + " | Zeilen: " + totals.rows
    + " | RmCur: " + Math.round(totals.curRm)
    + " | RmPick: " + Math.round(totals.pickRm)
    + " | Cur Rev: " + fmtMoney(totals.curRev) + " CHF"
    + " | Pick Rev: " + fmtMoney(totals.pickRev) + " CHF"
    + "</div>"
    + chartBlock
    + tableHtml
    + "</body></html>";

  const blob = new Blob([html], {type: "application/vnd.ms-excel;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "Gruppenbericht_" + stamp + "_mit_Charts.xls";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(a.href);
}

/* =================== DataTable =================== */
let sortRevCurDesc = true;
let sortRevPickDesc = true;
let sortMonthAsc = true;

$(function(){
  dt = $('#reportTable').DataTable({
    orderCellsTop:true,
    ordering:true,
    order: [],
    pageLength:25,
    lengthMenu:[10,25,50,100],
    dom:'Bfrtip',
    buttons:[
      {
        extend:'excelHtml5',
        title:'Gruppenbericht',
        text:'Excel (Daten)',
        exportOptions:{
          columns:function(idx){
            return idx !== COL_STATUSCODE && dt.column(idx).visible();
          },
          format:{
            body:function(data,row,col,node){
              if(col===2) return washToBool($(node).find('input.wash-check').prop('checked')) ? 'true':'false';
              if(col===3) return marketNormalize($(node).find('select.market-select').val()||'');
              return String(data).replace(/<[^>]*>/g,'');
            }
          }
        }
      },
      { text:'Excel (mit Charts)', action:function(){ downloadExcelWithCharts(); } },
      { extend:'colvis', text:'Spalten auswählen' }
    ],
    columnDefs:[
      { targets:0, className:'bbcol', width:'360px' },
      { targets:1, className:'accol', width:'440px' },
      { targets:3, className:'mktcol', width:'135px' },
      { targets:[6,9], className:'rmcol', width:'88px' },

      { targets:[4,5], render:renderOperaDateSort },

      { targets:2, render:renderWash },
      { targets:3, render:renderMarket },

      { targets:[6,9], render:renderInt },
      { targets:[7,10], render:renderCHF },
      { targets:[8,11], render:renderRate },

      { targets: COL_STATUSCODE, visible:false, searchable:true },
      { targets: COL_STATUS, orderData: [COL_STATUSCODE] }
    ],
    rowCallback:function(row,data){
      const code=String(data[COL_STATUSCODE]||'').toUpperCase().trim();
      row.classList.toggle('ten-row', code==='TEN');

      $('td', row).removeClass('neg');
      if(toNumber(data[7])<0) $('td', row).eq(7).addClass('neg');
      if(toNumber(data[10])<0) $('td', row).eq(10).addClass('neg');
    }
  });
  // ✅ expose dt for snapshot/injected loader
  window.dt = dt;

  // Spaltenfilter (Excel-like)
  $('#reportTable thead tr.filter-row th').each(function(i){
    $('input', this).on('keyup change clear', function(){
      const val = this.value || '';
      if(i === COL_STATUS){
        dt.column(COL_STATUSCODE).search(val, false, true).draw();
        return;
      }
      if(i === COL_STATUSCODE) return;
      dt.column(i).search(val || '').draw();
    });
  });

  // Status Dropdown filtert StatusCode exakt
  $('#statusSelect').on('change', function(){
    const v=(this.value||'').trim().toUpperCase();
    if(!v){
      dt.column(COL_STATUSCODE).search('', true, false).draw();
      return;
    }
    dt.column(COL_STATUSCODE).search('^'+v+'$', true, false).draw();
  });

  // Monat Dropdown: zeigt Buchungen, deren Zeitraum den Monat schneidet (Anreise/Abreise)
  $('#monthSelect').on('change', function(){
    monthQuick = (this.value || "").trim();
    dt.draw();
  });

  ['arrFrom','arrTo','depFrom','depTo','negOnly'].forEach(id=>{
    document.getElementById(id).addEventListener('change', function(){ dt.draw(); });
  });

  dt.on('draw', function(){ updateTotals(); upsertCharts(); });

  // preload injection (when opening snapshot)
  try{
    if(Array.isArray(window.__GB_PRELOADED_ROWS__) && window.__GB_PRELOADED_ROWS__.length){
      dt.clear();
      window.__GB_PRELOADED_ROWS__.forEach(function(r){ dt.row.add(r); });
      dt.draw();
    }else{
      loadTableFromLocal();
    }
  }catch(e){
    console.warn(e);
    loadTableFromLocal();
  }

  applyAutoLeisureAllRows();
  saveTableToLocal();
  updateTotals();
  upsertCharts();

  // Editable: Wash checkbox
  $('#reportTable tbody').on('change','input.wash-check',function(){
    const tr=$(this).closest('tr');
    const row=dt.row(tr);
    const data=row.data();
    data[2]=$(this).prop('checked');
    row.data(data).invalidate();
    saveTableToLocal();
    dt.draw();
  });

  // Editable: Market dropdown
  $('#reportTable tbody').on('change','select.market-select',function(){
    const tr=$(this).closest('tr');
    const row=dt.row(tr);
    const data=row.data();
    data[3]=marketNormalize($(this).val());
    row.data(data).invalidate();
    saveTableToLocal();
    dt.draw();
  });

  setMarketQuick("");
});

/* =================== Quickfilter Buttons =================== */
function setWashQuick(on){
  washQuickOn = !!on;
  document.getElementById('washQuickBtn').classList.toggle('active', washQuickOn);
  dt.draw();
}
function setMarketQuick(val){
  marketQuick = val || "";
  document.getElementById('mktAllBtn').classList.toggle('active', marketQuick==="");
  document.getElementById('mktCorpBtn').classList.toggle('active', marketQuick==="Corporate");
  document.getElementById('mktLeisBtn').classList.toggle('active', marketQuick==="Leisure");
  dt.draw();
}
document.getElementById('washQuickBtn').addEventListener('click', function(){ setWashQuick(!washQuickOn); });
document.getElementById('mktAllBtn').addEventListener('click', function(){ setMarketQuick(""); });
document.getElementById('mktCorpBtn').addEventListener('click', function(){ setMarketQuick("Corporate"); });
document.getElementById('mktLeisBtn').addEventListener('click', function(){ setMarketQuick("Leisure"); });

/* =================== Schnell-Sortierung Buttons + Reset =================== */
document.getElementById('sortRevCurBtn').addEventListener('click', function(){
  dt.order([7, sortRevCurDesc ? 'desc' : 'asc']).draw();
  sortRevCurDesc = !sortRevCurDesc;
});
document.getElementById('sortRevPickBtn').addEventListener('click', function(){
  dt.order([10, sortRevPickDesc ? 'desc' : 'asc']).draw();
  sortRevPickDesc = !sortRevPickDesc;
});
document.getElementById('sortResetBtn').addEventListener('click', function(){
  dt.order([]).draw();
});


document.getElementById('sortMonthBtn').addEventListener('click', function(){
  dt.order([[4, sortMonthAsc ? 'asc' : 'desc']]).draw();
  this.textContent = 'Sort: Monat (Anreise) ' + (sortMonthAsc ? '↑' : '↓');
  sortMonthAsc = !sortMonthAsc;
});


/* =================== Buttons =================== */
document.getElementById('chartsResetBtn').addEventListener('click', function(){ if(dt) dt.draw(); });

document.getElementById('clearBtn').addEventListener('click', function(){
  dt.clear().draw();
  updateTotals();
  try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
});
document.getElementById('resetBtn').addEventListener('click', function(){
  dt.columns().search('');
  dt.search('');
  document.querySelectorAll('.col-filter').forEach(function(i){ i.value=''; });
  document.getElementById('statusSelect').value='';
  document.getElementById('monthSelect').value='';
  monthQuick='';
  document.getElementById('arrFrom').value='';
  document.getElementById('arrTo').value='';
  document.getElementById('depFrom').value='';
  document.getElementById('depTo').value='';
  document.getElementById('negOnly').checked=false;

  setWashQuick(false);
  setMarketQuick("");

  dt.order([]).draw();
});

/* =================== Import =================== */
function addRowsFromOpera(text, sourceName){
  const firstLine=(text.split(/\r?\n/).find(l=>l.trim().length)||'');
  const delim=detectDelimiter(firstLine); // ✅ TAB/CSV erkannt
  const rows=parseDelimited(text, delim);
  if(!rows.length) return;

  // ✅ Header kann nicht zwingend in Zeile 1 sein (Opera-Report hat manchmal Vorspann)
  const hIdx = findHeaderRowIndex(rows);
  if(hIdx < 0){
    alert('Import-Fehler: Header nicht gefunden. Bitte exportiere als "Delimited Data" (TAB) inkl. Spaltennamen.');
    return;
  }

  const header=rows[hIdx];
  const map=buildHeaderMap(header);

  // ✅ robust: ARRIVALDATE/DEPARTUREDATE wird normalisiert erkannt
  if(map[normHeaderKey('ARRIVALDATE')]===undefined || map[normHeaderKey('DEPARTUREDATE')]===undefined){
    alert('Import-Fehler: Header fehlt. Zeile mit Spaltennamen muss ARRIVALDATE/DEPARTUREDATE enthalten.');
    return;
  }

  for(let i=hIdx+1;i<rows.length;i++){
    const cols=rows[i];
    if(!cols || !cols.length) continue;

    if(isFooterOrLabel(cols[0])) break;
    if(isGrandTotal(cols,map)) continue;
    if(isCurrencyOrVariance(cols,map)) continue;

    const pickRm=getCell(cols,map,'CP_PICKUPROOMNIGHTS');
    const pickRev=getCell(cols,map,'CP_PICKUPREVENUE');
    const prm=toNumber(pickRm);
    const pr=toNumber(pickRev);
    const pickRate=prm>0 ? (pr/prm) : 0;

    const statusRaw = normStatusRaw(getCell(cols,map,'BOOKING_STATUS') || getCell(cols,map,'BOOKINGSTATUS') || '');
    const statusCode = statusCodeFromAnyText(statusRaw); // ✅ CLX → CXL

    const accName = getCell(cols,map,'NVL_ACCOUNT_NAME_AGENT_NAME');

    dt.row.add([
      getCell(cols,map,'DESCRIPTION'),
      accName,
      false,
      (shouldAutoLeisure(accName) ? "Leisure" : ""),
      getCell(cols,map,'ARRIVALDATE'),
      getCell(cols,map,'DEPARTUREDATE'),
      getCell(cols,map,'CP_CURRENTROOMNIGHTS'),
      getCell(cols,map,'CP_CURRENTREVENUE'),
      getCell(cols,map,'CP_CURRENTAVGRATE'),
      pickRm,
      pickRev,
      pickRate,
      getCell(cols,map,'BOOK_ID'),
      statusRaw,
      sourceName || '',
      statusCode
    ]);
  }
}


document.getElementById('importFiles').addEventListener('change', async function(e){
  const files=Array.from(e.target.files||[]);
  if(!files.length) return;

  for(const file of files){
    const text=await file.text();
    addRowsFromOpera(text, file.name);
  }

  dt.draw();
  applyAutoLeisureAllRows();
  updateTotals();
  saveTableToLocal();
  e.target.value='';
});

/* =================== PDF Export (Logo entfernt; Charts + Tabelle) =================== */
document.getElementById('pdfBtn').addEventListener('click', async function(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'landscape', unit:'mm', format:'a4'});
  const stamp=new Date().toISOString().slice(0,10);

  // Seite 1: Charts
  doc.setFillColor(11,42,74);
  doc.rect(0,0,297,18,'F');
  doc.setFillColor(212,175,55);
  doc.rect(0,18,297,2,'F');
  doc.setTextColor(212,175,55);
  doc.setFontSize(16);
  doc.text('Gruppenbericht – Charts',14,12);

  const charts = [
    {id:'ch_rev_split', title:'Revenue Cur vs Pick', x:10,  y:28, w:135, h:62},
    {id:'ch_status_stack', title:'Revenue nach Status', x:152, y:28, w:135, h:62},
    {id:'ch_trend_kw', title:'Trend KW', x:10,  y:98, w:135, h:62},
    {id:'ch_top10_bb', title:'Top 10 Business Blocks', x:152, y:98, w:135, h:62},
  ];
  doc.setTextColor(11,42,74);
  doc.setFontSize(9);
  charts.forEach(c=>{
    const canvas = document.getElementById(c.id);
    const url = canvas && canvas.toDataURL ? canvas.toDataURL("image/png",1.0) : null;
    doc.text(c.title, c.x, c.y-3);
    if(url){
      try{ doc.addImage(url,'PNG',c.x,c.y,c.w,c.h); }catch(e){}
    }
  });

  // Seite 2: Tabelle
  doc.addPage();
  doc.setFillColor(11,42,74);
  doc.rect(0,0,297,18,'F');
  doc.setFillColor(212,175,55);
  doc.rect(0,18,297,2,'F');
  doc.setTextColor(212,175,55);
  doc.setFontSize(16);
  doc.text('Gruppenbericht – Tabelle',14,12);

  const visibleCols=[];
  dt.columns().every(function(i){ if(this.visible() && i !== COL_STATUSCODE) visibleCols.push(i); });

  const colNames={
    0:'Business Block',1:'Account',2:'Wash-Potenzial',3:'Market',4:'Anreise',5:'Abreise',
    6:'Rm Cur',7:'Revenue Cur',8:'Avg Cur',9:'Rm Pick',10:'Revenue Pick',11:'Avg Pick',
    12:'BB Id',13:'Status',14:'Quelle'
  };

  const rows=dt.rows({search:'applied'}).data().toArray();
  const totals=computeTotals(rows);

  const head=[ visibleCols.map(i=>colNames[i]||`Col ${i}`) ];
  const body=rows.map(r=>visibleCols.map(i=>{
    if(i===2) return washDisplay(r[2]);
    if(i===3) return marketNormalize(r[3]);
    if(i===7 || i===10) return fmtMoney(toNumber(r[i]))+" CHF";
    if(i===8 || i===11) return fmtMoney(toNumber(r[i]));
    if(i===6 || i===9) return String(Math.round(toNumber(r[i])));
    return String(r[i]??'').replace(/<[^>]*>/g,'');
  }));

  doc.autoTable({
    head: head, body: body,
    startY:24,
    styles:{fontSize:8, cellPadding:2, textColor:[29,29,31]},
    headStyles:{fillColor:[11,42,74], textColor:[212,175,55]},
    alternateRowStyles:{fillColor:[250,250,252]},
    didDrawPage:function(data){
      const y=data.cursor.y+6;
      doc.setFontSize(10);
      doc.setTextColor(11,42,74);
      doc.text(
        "Filter Total: Zeilen " + totals.rows
        + " | RmCur " + Math.round(totals.curRm)
        + " | RmPick " + Math.round(totals.pickRm)
        + " | Cur Rev " + fmtMoney(totals.curRev) + " CHF"
        + " | Pick Rev " + fmtMoney(totals.pickRev) + " CHF",
        14, y
      );
    }
  });

  doc.save("Gruppenbericht_" + stamp + ".pdf");
});

/* =================== ✅ HTML mit Daten speichern (Snapshot) =================== */
function __gb_snapshotRows(){
  if(typeof dt==='undefined' || !dt) return [];
  var rows = dt.rows().data().toArray().map(function(r){ return Array.prototype.slice.call(r); });
  rows.forEach(function(r){
    r[2] = washToBool(r[2]);
    r[3] = shouldAutoLeisure(r[1]) ? "Leisure" : marketNormalize(r[3]);
    ensureStatusCode(r);
  });
  return rows;
}
function __gb_safeJsonForScript(obj){
  return JSON.stringify(obj).replace(/</g, "\\u003c");
}
function downloadHtmlWithData(){
  if(typeof dt==='undefined' || !dt){ alert("Tabelle ist noch nicht bereit."); return; }

  var stamp = new Date().toISOString().slice(0,10);
  var rows = __gb_snapshotRows();
  var payload = __gb_safeJsonForScript(rows);

  var html = document.documentElement.outerHTML;

  // WICHTIG: kein echtes </scr"+"ipt> in Strings
  var openScript = "<scr" + "ipt>";
  var closeScript = "<" + "/scr" + "ipt>";

  var inject =
    openScript +
      "window.__GB_PRELOADED_ROWS__=" + payload + ";" +
      "window.addEventListener('load',function(){" +
        "setTimeout(function(){" +
          "try{" +
            "if(window.dt && Array.isArray(window.__GB_PRELOADED_ROWS__)){" +
              "dt.clear();" +
              "window.__GB_PRELOADED_ROWS__.forEach(function(r){dt.row.add(r);});" +
              "dt.draw();" +
              "if(window.applyAutoLeisureAllRows) applyAutoLeisureAllRows();" +
              "if(window.updateTotals) updateTotals();" +
              "if(window.upsertCharts) upsertCharts();" +
              "if(window.saveTableToLocal) saveTableToLocal();" +
            "}" +
          "}catch(e){console.warn(e);}" +
        "},350);" +
      "});" +
    closeScript +
    "</body>";

  html = html.replace("</body>", inject);

  var blob = new Blob([html], {type:"text/html;charset=utf-8"});
  var a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "Gruppenbericht_mit_Daten_" + stamp + ".html";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(a.href);
}
document.getElementById("saveHtmlBtn").addEventListener("click", downloadHtmlWithData);
</script>
</body>
</html>
